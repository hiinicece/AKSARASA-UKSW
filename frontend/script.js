// Museum Database with detailed info (Multi-language)
const museumDatabase = {
    "MUSEUM001": {
        code: "MUSEUM001",
        title: {
            id: "Wayang Kulit Arjuna",
            en: "Arjuna Shadow Puppet"
        },
        category: {
            id: "Wayang",
            en: "Puppet"
        },
        description: {
            id: "Wayang kulit ini menggambarkan tokoh Arjuna dari cerita Mahabharata. Dibuat dari kulit kerbau yang dikeringkan dan diukir dengan sangat detail, kemudian diberi warna menggunakan pewarna alami. Wayang ini memiliki tinggi sekitar 70 cm dan dipegang menggunakan tangkai dari tanduk kerbau. Arjuna digambarkan dengan postur yang gagah dan halus, mencerminkan karakternya sebagai ksatria yang tampan dan bijaksana. Wayang kulit merupakan warisan budaya Indonesia yang telah diakui UNESCO sebagai Masterpiece of Oral and Intangible Heritage of Humanity.",
            en: "This shadow puppet depicts Arjuna from the Mahabharata epic. Made from dried buffalo hide and intricately carved, then colored using natural dyes. The puppet stands approximately 70 cm tall and is held using a buffalo horn handle. Arjuna is portrayed with a graceful and noble posture, reflecting his character as a handsome and wise knight. Wayang kulit is Indonesia's cultural heritage recognized by UNESCO as a Masterpiece of Oral and Intangible Heritage of Humanity."
        },
        image: "https://images.unsplash.com/photo-1563729784474-d77dbb933a9e?w=600",
        duration: "32 menit"
    },
    "MUSEUM002": {
        code: "MUSEUM002",
        title: {
            id: "Lukisan Mona Lisa (Replika)",
            en: "Mona Lisa Painting (Replica)"
        },
        category: {
            id: "Lukisan",
            en: "Painting"
        },
        description: {
            id: "Replika lukisan terkenal karya Leonardo da Vinci yang dibuat pada awal abad ke-16. Lukisan ini menampilkan seorang wanita dengan senyum misterius yang telah menjadi ikon seni dunia. Teknik sfumato yang digunakan Leonardo menciptakan transisi halus antara warna dan bayangan. Mona Lisa adalah salah satu karya seni paling terkenal dan paling banyak dikunjungi di dunia. Replika ini dibuat dengan teliti untuk tujuan edukasi dan memberikan pengalaman apresiasi seni kepada pengunjung museum.",
            en: "A replica of the famous painting by Leonardo da Vinci created in the early 16th century. This painting features a woman with a mysterious smile that has become a world art icon. Leonardo's sfumato technique creates smooth transitions between colors and shadows. The Mona Lisa is one of the most famous and most visited works of art in the world. This replica was carefully crafted for educational purposes and to provide visitors with an art appreciation experience."
        },
        image: "https://images.unsplash.com/photo-1578632292335-df3abbb0d586?w=600",
        duration: "33 menit"
    },
    "MUSEUM003": {
        code: "MUSEUM003",
        title: {
            id: "Patung Venus de Milo (Replika)",
            en: "Venus de Milo Statue (Replica)"
        },
        category: {
            id: "Patung",
            en: "Sculpture"
        },
        description: {
            id: "Replika patung Yunani kuno yang menggambarkan dewi Aphrodite (Venus dalam mitologi Romawi). Patung asli dibuat sekitar tahun 100 SM dan ditemukan di pulau Milos, Yunani pada tahun 1820. Patung ini terkenal karena keindahan proporsinya dan misteri hilangnya kedua lengan. Tinggi patung sekitar 2 meter dan terbuat dari marmer putih. Gaya helenistik pada patung ini menunjukkan keahlian tinggi dalam memahat tubuh manusia dengan proporsi ideal.",
            en: "A replica of an ancient Greek statue depicting the goddess Aphrodite (Venus in Roman mythology). The original statue was created around 100 BC and discovered on the island of Milos, Greece in 1820. This statue is famous for its beautiful proportions and the mystery of its missing arms. The statue stands about 2 meters tall and is made of white marble. The Hellenistic style of this statue demonstrates high skill in sculpting the human body with ideal proportions."
        },
        image: "https://images.unsplash.com/photo-1566911814505-1c1c7a41cd0f?w=600",
        duration: "39 menit"
    },
    "MUSEUM004": {
        code: "MUSEUM004",
        title: {
            id: "Batik Tulis Lasem",
            en: "Lasem Hand-drawn Batik"
        },
        category: {
            id: "Tekstil",
            en: "Textile"
        },
        description: {
            id: "Kain batik tulis ini berasal dari Lasem, Jawa Tengah, yang terkenal dengan motif dan warna merahnya yang khas. Proses pembuatan batik ini memakan waktu hingga 3 bulan dengan menggunakan teknik tulis manual menggunakan canting. Motif pada batik ini menggabungkan pengaruh budaya Jawa dan Tionghoa, menciptakan corak yang unik dan indah. Warna merah yang dominan berasal dari pewarna alami mengkudu yang telah digunakan turun-temurun. Batik Lasem merupakan salah satu batik pesisir yang paling berharga dan mencerminkan akulturasi budaya yang harmonis.",
            en: "This hand-drawn batik cloth originates from Lasem, Central Java, famous for its distinctive patterns and red color. The batik-making process takes up to 3 months using manual writing technique with a canting tool. The patterns on this batik combine Javanese and Chinese cultural influences, creating unique and beautiful designs. The dominant red color comes from natural mengkudu dye that has been used for generations. Lasem batik is one of the most valuable coastal batiks and reflects harmonious cultural acculturation."
        },
        image: "https://images.unsplash.com/photo-1610066302019-e3b7ba3e4211?w=600",
        duration: "28 menit"
    },
    "MUSEUM005": {
        code: "MUSEUM005",
        title: {
            id: "Topeng Barong Bali",
            en: "Balinese Barong Mask"
        },
        category: {
            id: "Wayang",
            en: "Puppet"
        },
        description: {
            id: "Topeng Barong ini adalah representasi dari makhluk mitologi Bali yang melambangkan kebaikan dan kekuatan pelindung. Dibuat dengan teknik tradisional menggunakan kayu pule pilihan dan dihias dengan cat warna-warni cerah serta dilengkapi dengan bulu dan kain. Topeng ini digunakan dalam tarian Barong yang menceritakan pertarungan abadi antara kebaikan (Barong) dan kejahatan (Rangda). Setiap detail pada topeng ini memiliki makna simbolis yang dalam dalam kepercayaan Hindu Bali. Tarian Barong merupakan salah satu pertunjukan budaya yang paling populer di Bali.",
            en: "This Barong mask represents a Balinese mythological creature symbolizing goodness and protective power. Made using traditional techniques with selected pule wood and decorated with bright colorful paint along with fur and fabric. This mask is used in the Barong dance which tells the eternal battle between good (Barong) and evil (Rangda). Every detail on this mask has deep symbolic meaning in Balinese Hindu beliefs. The Barong dance is one of the most popular cultural performances in Bali."
        },
        image: "https://images.unsplash.com/photo-1578836537282-3171d77f8632?w=600",
        duration: "35 menit"
    },
    "1234567890": {
        code: "1234567890",
        title: {
            id: "Patung Buddha Kuno",
            en: "Ancient Buddha Statue"
        },
        category: {
            id: "Patung",
            en: "Sculpture"
        },
        description: {
            id: "Patung Buddha ini berasal dari abad ke-8 Masehi, ditemukan di Candi Borobudur. Patung ini menggambarkan Buddha dalam posisi meditasi yang menunjukkan pencapaian nirwana. Dibuat dari batu andesit dengan tinggi sekitar 1,5 meter, patung ini memiliki detail ukiran yang sangat halus pada jubah dan mahkota. Patung ini merupakan salah satu contoh terbaik dari seni pahat periode Mataram Kuno.",
            en: "This Buddha statue dates from the 8th century AD, found at Borobudur Temple. The statue depicts Buddha in a meditation position showing the attainment of nirvana. Made from andesite stone standing about 1.5 meters tall, this statue has very fine carving details on the robe and crown. This statue is one of the finest examples of sculpture art from the Ancient Mataram period."
        },
        image: "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?w=600",
        duration: "42 menit"
    }
};

let currentLanguage = 'id'; 

const translations = {
    id: {
        appTitle: "Aksarasa - Panduan Audio Museum",
        scanButton: "Scan Kamera",
        uploadButton: "Upload Gambar",
        historyTitle: "Riwayat Scan",
        emptyHistory: "Belum ada riwayat scan",
        scanTitle: "Pindai Barcode",
        scanInstruction: "Arahkan kamera ke barcode untuk memindai",
        playAudio: "Putar Audio",
        pauseAudio: "Jeda Audio",
        audioPlaying: "Memutar audio...",
        audioPaused: "Audio dijeda",
        uploading: "Memindai barcode...",
        uploadSuccess: "‚úì Barcode berhasil terdeteksi!",
        uploadError: "‚ùå Tidak dapat mendeteksi barcode. Pastikan gambar jelas dan fokus.",
        notFound: "Barcode tidak ditemukan dalam database",
        invalidFile: "Harap pilih file gambar yang valid",
        chatWithMascot: "Tanya Maskot AI",
        mascotName: "Musi - Maskot Museum",
        mascotStatus: "Siap membantu Anda",
        askQuestion: "Tanya sesuatu tentang item ini...",
        infoBoxText: "Arahkan kamera smartphone Anda ke barcode atau QR code yang tersedia di setiap koleksi museum untuk mendengar penjelasan lengkap"
    },
    en: {
        appTitle: "Aksara - Audio Guide Museum",
        scanButton: "Camera Scan",
        uploadButton: "Upload Image",
        historyTitle: "Scan History",
        emptyHistory: "No scan history yet",
        scanTitle: "Scan Barcode",
        scanInstruction: "Point camera at barcode to scan",
        playAudio: "Play Audio",
        pauseAudio: "Pause Audio",
        audioPlaying: "Playing audio...",
        audioPaused: "Audio paused",
        uploading: "Scanning barcode...",
        uploadSuccess: "‚úì Barcode detected successfully!",
        uploadError: "‚ùå Cannot detect barcode. Please ensure image is clear and focused.",
        notFound: "Barcode not found in database",
        invalidFile: "Please select a valid image file",
        chatWithMascot: "Ask AI Mascot",
        mascotName: "Musi - Museum Mascot",
        mascotStatus: "Ready to help you",
        askQuestion: "Ask something about this item...",
        infoBoxText: "Point your smartphone camera at the barcode or QR code available on each museum collection to hear a complete explanation"
    }
};

let scanHistory = [];
let html5QrCode = null;
let currentSpeech = null;
let currentAudio = null;
let isScanning = false;

const scanBtn = document.getElementById('scan-btn');
const uploadBtn = document.getElementById('upload-btn');
const fileInput = document.getElementById('file-input');
const scannerModal = document.getElementById('scanner-modal');
const uploadModal = document.getElementById('upload-modal');
const detailModal = document.getElementById('detail-modal');
const chatModal = document.getElementById('chat-modal');
const closeScannerBtn = document.getElementById('close-scanner');
const closeUploadBtn = document.getElementById('close-upload');
const closeDetailBtn = document.getElementById('close-detail');
const closeChatBtn = document.getElementById('close-chat');
const historyList = document.getElementById('history-list');
const emptyHistory = document.getElementById('empty-history');
const loadingOverlay = document.getElementById('loading-overlay');
const playAudioBtn = document.getElementById('play-audio-btn');
const pauseAudioBtn = document.getElementById('pause-audio-btn');
const audioStatus = document.getElementById('audio-status');
const previewImage = document.getElementById('preview-image');
const uploadStatus = document.getElementById('upload-status');
const langToggle = document.getElementById('lang-toggle');
const langText = document.getElementById('lang-text');
const chatWithAIBtn = document.getElementById('chat-with-ai-btn');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendChatBtn = document.getElementById('send-chat-btn');

let currentItemContext = null;
const API_BASE_URL = 'http://127.0.0.1:5000';
let chatHistory = [];

document.addEventListener('DOMContentLoaded', () => {
    loadLanguagePreference();
    loadHistory();
    setupEventListeners();
    checkBrowserSupport();
    updateTranslations();
});

function setupEventListeners() {
    scanBtn.addEventListener('click', openScanner);
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);
    closeScannerBtn.addEventListener('click', closeScanner);
    closeUploadBtn.addEventListener('click', closeUploadModal);
    closeDetailBtn.addEventListener('click', closeDetail);
    closeChatBtn.addEventListener('click', closeChat);
    playAudioBtn.addEventListener('click', playAudio);
    pauseAudioBtn.addEventListener('click', pauseAudio);
    langToggle.addEventListener('click', toggleLanguage);
    chatWithAIBtn.addEventListener('click', openChat);
    sendChatBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    scannerModal.addEventListener('click', (e) => {
        if (e.target === scannerModal) closeScanner();
    });
    
    uploadModal.addEventListener('click', (e) => {
        if (e.target === uploadModal) closeUploadModal();
    });
    
    detailModal.addEventListener('click', (e) => {
        if (e.target === detailModal) closeDetail();
    });
    
    chatModal.addEventListener('click', (e) => {
        if (e.target === chatModal) closeChat();
    });
}

function checkBrowserSupport() {
    if (!('speechSynthesis' in window)) {
        console.warn('Text-to-Speech not supported');
    }
}

async function openScanner() {
    scannerModal.classList.add('active');
    
    try {
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };

        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        );
        
        isScanning = true;
    } catch (err) {
        console.error("Error starting scanner:", err);
        alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.");
        closeScanner();
    }
}

async function closeScanner() {
    if (html5QrCode && isScanning) {
        try {
            await html5QrCode.stop();
            html5QrCode = null;
            isScanning = false;
        } catch (err) {
            console.error("Error stopping scanner:", err);
        }
    }
    scannerModal.classList.remove('active');
}

function onScanSuccess(decodedText) {
    if (isScanning) {
        closeScanner();
        processCode(decodedText);
    }
}

function onScanError(errorMessage) {
    // Ignore scan errors
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert(translations[currentLanguage].invalidFile);
        return;
    }
    
    uploadModal.classList.add('active');
    uploadStatus.textContent = translations[currentLanguage].uploading;
    uploadStatus.className = 'upload-status';
    
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImage.src = e.target.result;
        scanImageForBarcode(e.target.result);
    };
    reader.readAsDataURL(file);
    

    event.target.value = '';
}

async function scanImageForBarcode(imageDataUrl) {
    try {
        const img = document.createElement('img');
        img.src = imageDataUrl;
        
        img.onload = async () => {
            try {
                const html5QrCode = new Html5Qrcode("reader");
                
                const blob = await fetch(imageDataUrl).then(r => r.blob());
                const file = new File([blob], "barcode.png", { type: blob.type });
                
                const result = await html5QrCode.scanFile(file, true);
                
                uploadStatus.textContent = translations[currentLanguage].uploadSuccess;
                uploadStatus.className = 'upload-status success';
                
                setTimeout(() => {
                    closeUploadModal();
                    processCode(result);
                }, 1500);
                
            } catch (error) {
                console.error('Scan error:', error);
                uploadStatus.textContent = translations[currentLanguage].uploadError;
                uploadStatus.className = 'upload-status error';
            }
        };
        
    } catch (error) {
        console.error('Image load error:', error);
        uploadStatus.textContent = translations[currentLanguage].uploadError;
        uploadStatus.className = 'upload-status error';
    }
}

function closeUploadModal() {
    uploadModal.classList.remove('active');
    previewImage.src = '';
}

// Process scanned code
function processCode(code) {
    showLoading();
    
    setTimeout(() => {
        const itemData = museumDatabase[code];
        
        if (itemData) {
            addToHistory(itemData);
            showDetail(itemData);
        } else {
            showNotFound(code);
        }
        
        hideLoading();
    }, 800);
}

// History Management
function loadHistory() {
    const saved = localStorage.getItem('museumHistory');
    if (saved) {
        scanHistory = JSON.parse(saved);
        renderHistory();
    }
}

function saveHistory() {
    localStorage.setItem('museumHistory', JSON.stringify(scanHistory));
}

function addToHistory(item) {
    const exists = scanHistory.find(h => h.code === item.code);
    if (!exists) {
        scanHistory.unshift({
            ...item,
            timestamp: new Date().toISOString()
        });
        
        if (scanHistory.length > 20) {
            scanHistory = scanHistory.slice(0, 20);
        }
        
        saveHistory();
        renderHistory();
    }
}

function renderHistory() {
    if (scanHistory.length === 0) {
        historyList.style.display = 'none';
        emptyHistory.style.display = 'block';
        return;
    }
    
    historyList.style.display = 'flex';
    emptyHistory.style.display = 'none';
    
    historyList.innerHTML = scanHistory.map(item => {
        const itemData = museumDatabase[item.code];
        const title = itemData ? getText(itemData, 'title') : item.code;
        const category = itemData ? getText(itemData, 'category') : '';
        
        return `
        <div class="history-item" onclick="showDetailFromHistory('${item.code}')">
            <div class="history-item-header">
                <h3 class="history-item-title">${title}</h3>
                <svg class="history-item-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </div>
            <div class="history-item-meta">
                <span class="category-badge">${category}</span>
                <span class="duration-text">${item.duration} yang lalu</span>
            </div>
        </div>
    `}).join('');
}

function showDetailFromHistory(code) {
    const item = museumDatabase[code];
    if (item) {
        showDetail(item);
    }
}

function showDetail(item) {
    currentItemContext = item;
    
    document.getElementById('detail-image').src = item.image;
    document.getElementById('detail-title').textContent = getText(item, 'title');
    document.getElementById('detail-category').textContent = getText(item, 'category');
    document.getElementById('duration-text').textContent = item.duration;
    document.getElementById('detail-description').textContent = getText(item, 'description');
    
    detailModal.classList.add('active');
    
    playAudioBtn.style.display = 'flex';
    pauseAudioBtn.style.display = 'none';
    audioStatus.textContent = '';
    
    detailModal.dataset.currentCode = item.code;
    
    setTimeout(() => {
        playAudio();
    }, 500);
}

function closeDetail() {
    detailModal.classList.remove('active');
    
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
    }
    
    playAudioBtn.style.display = 'flex';
    pauseAudioBtn.style.display = 'none';
    audioStatus.textContent = '';
}

function showNotFound(code) {
    const notFoundData = {
        code: code,
        title: {
            id: "Item Tidak Ditemukan",
            en: "Item Not Found"
        },
        category: {
            id: "Tidak Diketahui",
            en: "Unknown"
        },
        description: {
            id: `Kode ${code} tidak terdaftar dalam database museum. Silakan hubungi petugas museum untuk informasi lebih lanjut atau coba scan kode lain.`,
            en: `Code ${code} is not registered in the museum database. Please contact museum staff for more information or try scanning another code.`
        },
        image: "https://images.unsplash.com/photo-1594225077323-6f24d0026d72?w=600",
        duration: "0 menit"
    };
    
    showDetail(notFoundData);
}

// Audio Functions
function playAudio() {
    if (currentSpeech) {
        window.speechSynthesis.cancel();
    }
    
    const title = document.getElementById('detail-title').textContent;
    const category = document.getElementById('detail-category').textContent;
    const description = document.getElementById('detail-description').textContent;
    
    const categoryLabel = currentLanguage === 'id' ? 'Kategori' : 'Category';
    const textToSpeak = `${title}. ${categoryLabel}: ${category}. ${description}`;
    
    currentSpeech = new SpeechSynthesisUtterance(textToSpeak);
    currentSpeech.lang = getTTSLang();
    currentSpeech.rate = 0.9;
    currentSpeech.pitch = 1.0;
    currentSpeech.volume = 1.0;
    
    currentSpeech.onstart = () => {
        playAudioBtn.style.display = 'none';
        pauseAudioBtn.style.display = 'flex';
        audioStatus.textContent = translations[currentLanguage].audioPlaying;
    };
    
    currentSpeech.onend = () => {
        playAudioBtn.style.display = 'flex';
        pauseAudioBtn.style.display = 'none';
        const endText = currentLanguage === 'id' ? '‚úì Audio selesai diputar' : '‚úì Audio finished';
        audioStatus.textContent = endText;
    };
    
    currentSpeech.onerror = (event) => {
        console.error('Speech error:', event);
        playAudioBtn.style.display = 'flex';
        pauseAudioBtn.style.display = 'none';
        const errorText = currentLanguage === 'id' ? '‚ùå Gagal memutar audio' : '‚ùå Failed to play audio';
        audioStatus.textContent = errorText;
    };
    
    window.speechSynthesis.speak(currentSpeech);
}

function pauseAudio() {
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        playAudioBtn.style.display = 'flex';
        pauseAudioBtn.style.display = 'none';
        audioStatus.textContent = translations[currentLanguage].audioPaused;
    }
}

// Loading
function showLoading() {
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    loadingOverlay.style.display = 'none';
}

// Cleanup
window.addEventListener('beforeunload', () => {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
    }
    if (html5QrCode && isScanning) {
        html5QrCode.stop();
    }
});

// Language Functions
function loadLanguagePreference() {
    const savedLang = localStorage.getItem('preferredLanguage');
    if (savedLang) {
        currentLanguage = savedLang;
    }
    updateLangButton();
}

function toggleLanguage() {
    currentLanguage = currentLanguage === 'id' ? 'en' : 'id';
    localStorage.setItem('preferredLanguage', currentLanguage);
    updateLangButton();
    updateTranslations();
    
    loadHistory();
}

function updateLangButton() {
    langText.textContent = currentLanguage === 'id' ? 'EN' : 'ID';
}

function updateTranslations() {
    const t = translations[currentLanguage];
    
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (t[key]) {
            element.textContent = t[key];
        }
    });
}

function getText(item, field) {
    if (typeof item[field] === 'object' && item[field][currentLanguage]) {
        return item[field][currentLanguage];
    }
    return item[field];
}

function getTTSLang() {
    return currentLanguage === 'id' ? 'id-ID' : 'en-US';
}

function openChat() {
    chatModal.classList.add('active');
    chatHistory = [];
    chatMessages.innerHTML = '';
    
    const welcomeMessage = currentLanguage === 'id' 
        ? `Halo! üëã Saya Musi, maskot museum. Saya akan dengan senang hati menjawab pertanyaan Anda tentang ${getText(currentItemContext, 'title')}. Ada yang ingin Anda tanyakan?`
        : `Hello! üëã I'm Musi, the museum mascot. I'll be happy to answer your questions about ${getText(currentItemContext, 'title')}. What would you like to know?`;
    
    addMessageToChat('ai', welcomeMessage);
    chatInput.focus();
}

function closeChat() {
    chatModal.classList.remove('active');
    chatInput.value = '';
    
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
    }
}

function addMessageToChat(sender, message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${sender}`;
    avatar.textContent = sender === 'ai' ? 'ü§ñ' : 'üë§';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = message;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    chatMessages.appendChild(messageDiv);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message ai';
    typingDiv.id = 'typing-indicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar ai';
    avatar.textContent = 'ü§ñ';
    
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.appendChild(indicator);
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
}

async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;
    
    addMessageToChat('user', message);
    chatInput.value = '';
    sendChatBtn.disabled = true;
    
    showTypingIndicator();
    
    try {
        const response = await fetch(`${API_BASE_URL}/api/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                itemContext: {
                    title: getText(currentItemContext, 'title'),
                    category: getText(currentItemContext, 'category'),
                    description: getText(currentItemContext, 'description')
                },
                language: currentLanguage,
                timestamp: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();

        removeTypingIndicator();

        if (data.success) {
            addMessageToChat('ai', data.response);

            if (data.audio_url) {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                currentAudio = new Audio(`${API_BASE_URL}${data.audio_url}`);
                currentAudio.play().catch(err => console.warn("Gagal memutar audio:", err));
            }
        } else {
            throw new Error(data.error || 'Unknown error');
        }

        
    } catch (error) {
        console.error('Chat error:', error);
        removeTypingIndicator();
        
        const errorMessage = currentLanguage === 'id'
            ? '‚ùå Maaf, terjadi kesalahan. Pastikan server backend sudah berjalan di http://localhost:5000'
            : '‚ùå Sorry, an error occurred. Make sure the backend server is running at http://localhost:5000';
        
        addMessageToChat('ai', errorMessage);
    } finally {
        sendChatBtn.disabled = false;
        chatInput.focus();
    }
}